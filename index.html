<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
    <meta name="description" content="Hexatic room. Maximize distance between individuals">
    <meta name="keywords" content="hexatic, room, optimization, security distance, coronavirus, health">
    <meta name="Author" content="Cesar Lopez Pastrana, PhD">
    <title>Hexatic Room (CLP) | Home</title>
    <link rel="stylesheet" href="styles.css" type="text/css">
    <style type="text/css">
<!--
.Estilo1 {color: #999999}
-->
  </style>
  </head>
  <body style="                 color: rgb(0, 0, 0); background-color: rgb(0, 10, 30);"
    vlink="#990099" link="#000099" alink="#000099">
    <div style="text-align: center;">
      <table style="text-align: left; height: 150px; width: 1091px;" cellspacing="0"
        cellpadding="0" border="0" align="center">
        <tbody>
          <tr align="center">
            <td colspan="1" rowspan="1" style="text-align: left; vertical-align: middle; width: 627px; background-color: white;"
              height="100"><big><big><big><span style="font-family: Helvetica,Arial,sans-serif; font-weight: bold; color:#990000"><br>
                      &nbsp;<span style="color: #121c12;">HEXATIC ROOM &nbsp;</span>&nbsp;&nbsp;&nbsp;
                      <br><br>
                    </span></big></big></big></td>
            <td rowspan="1" style="text-align: center; vertical-align: middle; width: 218px; background-color: white; margin-left: 1145px; height: 100px;"
              width="157" height="100"> <img src="logo.png" alt="logo" title="l"
                style="width: 255px; height: 121px;"></td>
          </tr>
        </tbody>
      </table>
      <p>&nbsp;</p>
      <table style="text-align: left; width: 1092px; height: 334px;" cellspacing="0"
        cellpadding="0" bordercolor="#FFFFFF" border="0" align="center">
        <tbody>
          <tr align="center">
            <td rowspan="1" class="table_general" style="text-align: left; vertical-align: top; background-color: white; margin-left: -94px;"
              width="20" height="100">
              <p class="table_general">&nbsp;</p>
            </td>
            <td rowspan="1" class="table_general" style="text-align: left; vertical-align: top; background-color: white; margin-left: 62px;"
              width="269"> <br>
              <a href="instructions.htm">Read instructions &gt;&gt;</a><br>
              <br>
              <br>
              Load plan: <input id="file_input" type="file"><br>
              <br>
              <input id="room_sq" name="shape_type" checked="checked" value="room"
                type="radio"><label for="room_sq">Room</label> <input id="restraints"
                name="shape_type" value="general" type="radio"><label for="restraints">Restraints</label>
              <input id="scale" name="shape_type" value="scale" type="radio"><label
                for="scale">Scale</label>&nbsp;&nbsp;&nbsp;&nbsp; Scale value: <input
                id="scale_value" value="2" size="3" type="number">
              meters&nbsp;&nbsp;&nbsp;&nbsp; #Individuals: <input id="individuals"
                value="15" size="3" type="number"><br>
              <br>
              <button id="analyze">Analyze</button>
              <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/3.4.0/fabric.min.js"></script>
              (This may take a while)<br>
              <br>
              <div style="text-align: center;"> <canvas id="plane_canvas" width="970"
                  height="500" style="border:4px solid #ccc"></canvas></div>
              <br>
              <button id="clear">Clear all</button>&nbsp;&nbsp;&nbsp;&nbsp; <button
                id="download">Download</button><br>
              <br>
              <br>
              <b>Log console:</b>
              <p id="log_console_id">&gt;&gt; </p>
              <br>
              <br>
              <br>
              &nbsp;
              <script>
    /*

    This script calculates the optimum arrangment of humans in a room
    with constrains indicated by the user 
    
    Copyright (C) 2020 Cesar Lopez Pastrana

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.
  
*/

// Global variables
var room_selected = 0;
var room0 = [0,0];
var roomf = [0,0]

var n_restraints = 0;
var restraints0 = [];
var restraintsf = [];

var scale_selected = 0;
var scale;

var canvas = new fabric.Canvas('plane_canvas', { selection: true });
var rect, is_down, x0, y0;



///////////////////////////////////////////////////////////////////////////
// 0. Canvas drawing functions                                           //
///////////////////////////////////////////////////////////////////////////

/*+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/

canvas.on('mouse:down', function(o){


    is_down = true;
    var pointer = canvas.getPointer(o.e);
    x0 = pointer.x;
    y0 = pointer.y;
    
    if (document.getElementById("room_sq").checked == true) {
        rect = new fabric.Rect({
            left: x0,
            top: y0,
            originX: 'left',
            originY: 'top',
            width: pointer.x-x0,
            height: pointer.y-y0,
            angle: 0,
            fill: 'rgba(0,0,0,0.0)',
            stroke: 'rgba(0,0,150,1)', 
            strokeWidth: 3, 
            //transparentCorners: false,
            selectable: false
        });
        canvas.add(rect);
        room_selected = 1;
        room0[0] = x0;
        room0[1] = y0;
        
    } else if (document.getElementById("restraints").checked == true) {
        rect = new fabric.Rect({
            left: x0,
            top: y0,
            originX: 'left',
            originY: 'top',
            width: pointer.x-x0,
            height: pointer.y-y0,
            angle: 0,
            fill: 'rgba(200,0,0,0.1)',
            stroke: 'rgba(150,0,0, 1)', 
            strokeWidth: 3, 
            //transparentCorners: false,
            selectable: false
            
        });
        canvas.add(rect);
    
        restraints0.push(x0);
        restraints0.push(y0);
        
    } else if (document.getElementById("scale").checked == true) {
        rect = new fabric.Line([x0, y0, pointer.x, y0],{
            stroke: 'rgba(200,200,0,1)', 
            strokeWidth: 3, 
            selectable: false
        });
        canvas.add(rect);
    }
    
});


canvas.on('mouse:move', function(o){

    if (!is_down) return;
    
    var pointer = canvas.getPointer(o.e);
    
    if(x0>pointer.x){
        rect.set({ left: Math.abs(pointer.x) });
    } 
    if(y0>pointer.y){
        rect.set({ top: Math.abs(pointer.y) });
    }
    
    if(document.getElementById("scale").checked == true) {
        rect.set({ width: Math.abs(x0 - pointer.x) });
        rect.set({ height: 0 });
    } else {
        rect.set({ width: Math.abs(x0 - pointer.x) });
        rect.set({ height: Math.abs(y0 - pointer.y) });
    }

    canvas.renderAll();
     
});

canvas.on('mouse:up', function(o){
  
  is_down = false;
  var pointer = canvas.getPointer(o.e);

  if (document.getElementById("room_sq").checked == true) {
     roomf[0] = pointer.x;
     roomf[1] = pointer.y;
     
     // Exchange to have the largest values first
     if(roomf[0] < room0[0]) {
        roomf[0] = roomf[0] + room0[0];
        room0[0] = roomf[0] - room0[0];
        roomf[0] = roomf[0] - room0[0];
     }
     
    if(roomf[1] < room0[1]) {
        roomf[1] = roomf[1] + room0[1];
        room0[1] = roomf[1] - room0[1];
        roomf[1] = roomf[1] - room0[1];
     }
     
    
  } else if (document.getElementById("restraints").checked == true) {
   
        restraintsf.push(pointer.x);
        restraintsf.push(pointer.y);
        n_restraints++;
        
        // Exchange to have the largest values first
        if(restraintsf[2*n_restraints] < restraints0[2*n_restraints]) {
            restraintsf[2*n_restraints] = restraintsf[2*n_restraints] + restraints0[2*n_restraints];
            restraints0[2*n_restraints] = restraintsf[2*n_restraints] - restraints0[2*n_restraints];
            restraintsf[2*n_restraints] = restraintsf[2*n_restraints] - restraints0[2*n_restraints];
        }
        
        if(restraintsf[2*n_restraints+1] < restraints0[2*n_restraints+1]) {
            restraintsf[2*n_restraints+1] = restraintsf[2*n_restraints+1] + restraints0[2*n_restraints+1];
            restraints0[2*n_restraints+1] = restraintsf[2*n_restraints+1] - restraints0[2*n_restraints+1];
            restraintsf[2*n_restraints+1] = restraintsf[2*n_restraints+1] - restraints0[2*n_restraints+1];
        }
        
  } else if (document.getElementById("scale").checked == true) {
        scale =  Number(document.getElementById("scale_value").value)/Math.abs(x0 - pointer.x); // Scale in meters/pixels
        scale_selected = 1;
  }
   
}); 

/*----------------------------------------------------------------------*/

///////////////////////////////////////////////////////////////////////////
// Load image (plane)                                                    // 
///////////////////////////////////////////////////////////////////////////

/*+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/


document.getElementById("file_input").addEventListener("change", function(e) {
   
   var file = e.target.files[0];
   var reader = new FileReader();
   var bgi;
   var mw;
   reader.onload = function(f) {
      var data = f.target.result;
      fabric.Image.fromURL(data, function(img) {    
         canvas.setDimensions({width:img.width, height: img.height});
         // add background image
         canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas), {
          
            //scaleX: img.width,
            //scaleY: img.height
            
            //scaleX: canvas.width / img.width,
            //scaleY: canvas.height / img.height
         });
      });
      
        
   };
   reader.readAsDataURL(file);
   
});

/*----------------------------------------------------------------------*/



///////////////////////////////////////////////////////////////////////////
// Download image                                                        // 
///////////////////////////////////////////////////////////////////////////

/*+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/

// Nice method by Bematobu stackoverflow
// https://stackoverflow.com/questions/10673122/how-to-save-canvas-as-an-image-with-canvas-todataurl
// Convert canvas to image
document.getElementById('download').addEventListener("click", function(e) {
    var canvas = document.getElementById("plane_canvas");
    var dataURL = canvas.toDataURL("image/jpeg", 1.0);
    download_image(dataURL, 'hexatic_room.jpeg');
});

// Save | Download image
function download_image(data, filename = 'hexatic_room.jpeg') {
    var a = document.createElement('a');
    a.href = data;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
}

/*----------------------------------------------------------------------*/


document.getElementById('clear').addEventListener("click", function(e) {
    //var canvas = document.getElementById("plane_canvas");
    canvas.remove(...canvas.getObjects());
    //canvas.renderAll();
    
    room_selected = 0;
    room0 = [0,0];
    roomf = [0,0]

    n_restraints = 0;
    restraints0 = [];
    restraintsf = [];
    scale_selected = 0;
    
   // console.log("Clear");
});


///////////////////////////////////////////////////////////////////////////
// MAIN FUNCTION: Monte Carlo minimisastion                              // 
///////////////////////////////////////////////////////////////////////////

/*+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/

//https://stackoverflow.com/questions/20927807/is-it-possible-to-make-global-variable-in-javascript
//get reference to button
var btn_analysis = document.getElementById('analyze');
btn_analysis.addEventListener('click', function(event) {
    mc_analysis(room0, roomf, restraints0, restraintsf, n_restraints, canvas);
});



function mc_analysis(room0, roomf, restraints0, restraintsf, n_restraints, canvasid)
{
    if(room_selected==0) {
        window.alert("Please, draw a main room area");
        document.getElementById("log_console_id").innerHTML = document.getElementById("log_console_id").innerHTML + "Main room not drawn<br>>> "
        return 1;
    }
    

    var N_INDIVIDUALS = Number(document.getElementById("individuals").value);
    var rx = [];    // Final coordinates of the particles x coordinate
    var ry = [];    // Final coordinates of the particles y coordinate
    
    // 1. Initial placement of particles
    var tx, ty;
    var tni=0;
    
    do{
         tx = Math.floor((Math.random()*(roomf[0] - room0[0]) ) + room0[0]);
         ty = Math.floor((Math.random()*(roomf[1] - room0[1]) ) + room0[1]);
         
         if(is_coord_suited(tx, ty, room0, roomf, restraints0, restraintsf, n_restraints) == 1) {
            rx.push(tx);
            ry.push(ty);
            tni++;
         }
    } while(tni<N_INDIVIDUALS);
 	

 	 
 	 // 2. Total (effective) area and parameter distance
 	 var S_room = (roomf[0]-room0[0])*(roomf[1]-room0[1]);

 	 for(i=0;i<n_restraints;i++) 
        S_room -= (restraintsf[0]-restraints0[0])*(restraintsf[1]-restraints0[1]);
 	 
    // 3. Energy initial configuration
    const L0sq =  2*S_room/( Math.sqrt(3)*N_INDIVIDUALS );
    const L0_THR = 2;       // Threshold meters for the separation between persons
 	 
    document.getElementById("log_console_id").innerHTML = document.getElementById("log_console_id").innerHTML + "Analyzing "
    if(scale_selected==0)
        document.getElementById("log_console_id").innerHTML = document.getElementById("log_console_id").innerHTML + "(scale not selected)... "
    else {
        var l0 = Math.sqrt(L0sq)*scale;
        document.getElementById("log_console_id").innerHTML = document.getElementById("log_console_id").innerHTML + "(expected average separation "
        
        if(l0<L0_THR)
            document.getElementById("log_console_id").innerHTML = document.getElementById("log_console_id").innerHTML + "<b style=\"color:red\">" + l0.toFixed(2) + " meters</b>, "
        else
            document.getElementById("log_console_id").innerHTML = document.getElementById("log_console_id").innerHTML + l0.toFixed(2) + " meters,"
            
        let max_N = 2*S_room*scale*scale/(L0_THR*L0_THR*Math.sqrt(3));
        document.getElementById("log_console_id").innerHTML = document.getElementById("log_console_id").innerHTML + "maximum number of persons for the area given with 2 meters separation ~ " + Math.round(max_N) + " persons)... "
    }
 	 
 	 var L06 = L0sq*L0sq*L0sq;
 	 var L012 = L06*L06;
 	 var L_CUT = 4*4*L0sq;
 	 var E=0;
   E = energy(rx,ry,N_INDIVIDUALS, L012, L_CUT);

 	   
 	 // 4. Monte Carlo minimisation
 	 const MC_STEPS = 60000;
 	 const mcs = 20;
 	 const BETA = 1;
 	
     var tx,ty;
 	 var tE;
 	 var query;
 	    
 	 for(let m=0; m<MC_STEPS; m++) {
        for(let n=0; n<N_INDIVIDUALS; n++) {
           
            // Trial step
            tx = rx[n]; 
            ty = ry[n];
            rx[n] += mcs*(Math.random() - 0.5);
            ry[n] += mcs*(Math.random() - 0.5);
            
            // Configuration suitable?
            query = is_coord_suited(rx[n], ry[n], room0, roomf, restraints0, restraintsf, n_restraints);
            
            if( query == 1) {
                tE =  energy(rx,ry,N_INDIVIDUALS, L012, L_CUT);
                if( Math.random() < Math.exp( -(tE-E)/BETA) )
                    E = tE;
                else {
                    rx[n] = tx;
                    ry[n] = ty;
                }
                
            } else {
                rx[n] = tx;
                ry[n] = ty;
            }
            
            
        }
 	 }
 	 
 	 
    // Draw final configuration
    for(i=0;i<N_INDIVIDUALS; i++) 
        draw_cross(canvasid, rx[i], ry[i]);   
 	 
    // Obtain final statistics
    document.getElementById("log_console_id").innerHTML = document.getElementById("log_console_id").innerHTML + "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Done! " 
    dists = calcd(rx,ry,N_INDIVIDUALS);
    if(scale_selected==1) {
        let ave_mds = mean(dists)*scale;
        let std_mds = std(dists)*scale;
        let m_mds = min(dists)*scale;
        document.getElementById("log_console_id").innerHTML = document.getElementById("log_console_id").innerHTML + "<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Average minimum distances found: " + ave_mds.toFixed(2) + " +/- " + std_mds.toFixed(2) + " meters (minimum distance " 
        if(m_mds<L0_THR)
            document.getElementById("log_console_id").innerHTML = document.getElementById("log_console_id").innerHTML  + "<b style=\"color:red\">" + m_mds.toFixed(2) + "</b> meters)."
        else
             document.getElementById("log_console_id").innerHTML = document.getElementById("log_console_id").innerHTML  + m_mds.toFixed(2) + " meters)."
    }
    document.getElementById("log_console_id").innerHTML = document.getElementById("log_console_id").innerHTML + "<br>>> " 
}


/*******************************************************************************/
/*                              is_coord_suited                                */
/* Checks if the coordinates are located inside the room and not inside a      */
/* regions restrained                                                          */
/*******************************************************************************/
function is_coord_suited(x, y, room0, roomf, restraints0, restraintsf, n_restraints)
{ 
    let ics=1;
    
    // Is inside the room?
    if(x<room0[0])
        ics=0;
    if(x>roomf[0])
        ics=0;
    if(y<room0[1])
        ics=0;
    if(y>roomf[1])
        ics=0;
    
    // Is outside the restrains?
    let xr0, yr0;
    let xrf, yrf;
     
    for(let r=0; r<n_restraints; r++) {
        xr0 = restraints0[2*r];
        yr0 = restraints0[2*r+1];
        xrf = restraintsf[2*r];
        yrf = restraintsf[2*r+1];
        
        if(x>xr0 && x<xrf) {
            if(y>yr0 && y<yrf) {
                ics = 0;
                break;
            }
        }
    }
    
    return ics;
}



/*******************************************************************************/
/*                                energy                                       */
/* Energy function for the current configuration of particles                  */
/*******************************************************************************/
function energy(rx,ry,np, L0, L_CUT) 
{
    let E=0;
    let d2, d6,d12;
    let rxi,rxy;
    
    for(let i=0;i<np; i++) {
        rxi = rx[i];
        ryi = ry[i];
        for(let j=i+1; j<np; j++) {
            d2 = (rxi-rx[j])*(rxi-rx[j])  + (ryi-ry[j])*(ryi-ry[j]);
            if(d2 < L_CUT){
                d6 = d2*d2*d2;
                d12 = d6*d6;
                E += L0/d12;
            }
        }
    }
    return E;
}



/*******************************************************************************/
/*                                draw_cross                                   */
/* This function draws a cross at the specified coordinates                    */
/*******************************************************************************/
function draw_cross(canvasid,x,y)
{
    var w = 6;
    lv = new fabric.Line([x-w, y, x+w, y],{
            stroke: 'rgba(150,0,0,1)', 
            strokeWidth: 3, 
            //transparentCorners: false,
            selectable: false
        });
    canvas.add(lv);
    
    lh = new fabric.Line([x, y-w, x, y+w],{
            stroke: 'rgba(150,0,0,1)', 
            strokeWidth: 3, 
            //transparentCorners: false,
            selectable: false
        });
    canvas.add(lh);
}


/*******************************************************************************/
/*                                     calcd                                   */
/* Extracyt the minimium distance beween every particle with all thehe rest    */
/*******************************************************************************/
function calcd(rx,ry,np)
{

    var dists = new Array(np);
    
    for(let i=0; i<np; i++)
        dists[i] = 9999999999999;
    
    for(let d=0; d<np; d++) {
        for(let i=0;i<np; i++) {
            if(d!=i) {
                let td = Math.sqrt( (rx[d]-rx[i])*(rx[d]-rx[i]) +  (ry[d]-ry[i])*(ry[d]-ry[i])  );
                if(td < dists[d])
                    dists[d] = td;
            }
        }
    }
    
    return dists;
    
}

/*******************************************************************************/
/*                                   mean                                      */
/* Calcuates the mean of array v                                               */
/*******************************************************************************/
function mean(v)
{   
    let ave=0;
    let elements = v.length;
    for(let i=0;i<elements;i++)
        ave += v[i];
    return ave/elements;
}

/*******************************************************************************/
/*                                   std                                       */
/* Calcuates the standard deviation of array v                                 */
/*******************************************************************************/
function std(v)
{
    let ave = mean(v);
    let elements = v.length;
    let std=0;
    for(let i=0;i<elements;i++)
        std += (v[i]-ave)*(v[i]-ave);
    return Math.sqrt(std/(elements-1));
}

/*******************************************************************************/
/*                                   min                                       */
/* Calcuates the minimum value is array v                                      */
/*******************************************************************************/
function min(v)
{
    let elements=v.length;
    m = v[0];
    for(let i=1; i<elements;i++){
        if(v[i]<m)
            m=v[i];
    }
    
    return m;
}

/*----------------------------------------------------------------------*/

</script> <br> <br>
              <p><br>
              </p>
              <p><br>
              </p>
              <p><br>
              </p>
              <p><br>
              </p>
              <p><br>
              </p>
              <p><br>
              </p>
              <p><br>
              </p>
              <p><br>
              </p>
            </td>
            <td rowspan="1" class="table_back_right" style="text-align: left; vertical-align: middle; width: 20px; background-color: rgb(255, 255, 255);"
              width="20" height="100" align="center">&nbsp;</td>
          </tr>
        </tbody>
      </table>
      <span style="color: #999999;"><font size="2"><br>
        </font></span></div>
    <div style="text-align: center;"><span style="color: #999999;"><font size="2"><br>
        </font></span></div>
    <div style="text-align: center;"><span style="color: #999999;"><font size="2"><br>
        </font></span></div>
    <div style="text-align: center; background-color: #000a1e;"><span style="color: #cccccc;"><font
          size="2">C&eacutesar L&oacutepez Pastrana, 2020</font></span></div>
    <div style="text-align: center; background-color: #000a1e;"><span style="color: #cccccc;"><font
          size="2"><br>
        </font></span></div>
    <div style="text-align: center; background-color: #000a1e;"><span style="color: #cccccc;"><font
          size="2"><br>
        </font></span></div>
  </body>
</html>
